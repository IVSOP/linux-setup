# Install arch. This is just a normal installation following the guides, but with a more complicated filesystem setup, which is why I prefer to do things manually

# Prerequisites:

At least 1h of time to allow troublheshooting

Ethernet, to speed up things

Secure boot disabled

Have the partition layout already planned out

## Connect to the internet

Ensure you are connected: `ip link` and `ping archlinux.org`

If you need wifi, use `iwctl`

## timedatectl
`timedatectl`

## Format disks

Warning: if you have windows, an efi partition already exists and you don't need to make a new one

Use `fdisk`

Boot: 512M

efi: 100M, set the type to EFI System

## Make filesystems for boot

Efi should be fat32, boot can be ext4

Do not mount anything yet

## Create encrypted partitions

Run this to create a luks container in a device (use some partition from /dev): `cryptsetup luksFormat <device>`

Then open the partitions with `cryptsetup luksOpen <devive> <mapper_name>`

## Logical volumes on top of the encrypted volumes

Create physical volume: `pvcreate /dev/mapper/<mapper_name>`

Create logical group: `vgcreate <lvm_group_name> <list of devices, for now /dev/mapper/<mapper_name>>`

Create logical volume for swap: `lvcreate -L 8G -n swap <lvm_group_name>`

Create logical volume for root: `lvcreate -l 100%FREE -n root <lvm_group_name>` # -l vs -L on purpose, this is not wrong

## Create filesystems for swap and root

`mkswap /dev/<lvm_group_name>/swap`

`mkfs.ext4 /dev/<lvm_group_name>/root`

## Mount

`mount /dev/<lvm_group_name>/root /mnt`

`swapon /dev/<lvm_group_name>/swap`

`mount <boot> /mnt/boot`

`mount <efi> /mnt/boot/efi`

## Pacstrap

`pacman -Sy archlinux-keyring`

**NOTE:** If you have an intel cpu, replace `amd-ucode` with `intel-ucode`

`pacstrap -K /mnt base linux linux-firmware sudo neovim networkmanager amd-ucode grub efibootmgr less openssh lvm2 os-prober ntfs-3g`

## Fstab

`genfstab -U /mnt >> /mnt/etc/fstab`

## Chroot

`arch-chroot /mnt`

## Setup pacman

Mirrors (yours might be different, run reflector, the command is listed here)

Copy to /etc/pacman.d/mirrorlist:

```
################################################################################
################# Arch Linux mirrorlist generated by Reflector #################
################################################################################

# With:       reflector --verbose -l 5 -n 20 -p http --sort rate --save /etc/pacman.d/mirrorlist
# When:       2024-09-16 15:22:46 UTC
# From:       https://archlinux.org/mirrors/status/json/
# Retrieved:  2024-09-16 15:22:22 UTC
# Last Check: 2024-09-16 13:58:52 UTC

Server = http://arch.mirror.constant.com/$repo/os/$arch
Server = http://mirror.moson.org/arch/$repo/os/$arch
Server = http://md.mirrors.hacktegic.com/archlinux/$repo/os/$arch
Server = http://al.arch.niranjan.co/$repo/os/$arch
Server = http://arch.niranjan.co/$repo/os/$arch
```

Parallel downloads and multilib:

edit `/etc/pacman.conf`, uncomment multilib and set ParallelDownloads to 5

## Time zone and hwclock

`ln -sf /usr/share/zoneinfo/<Region>/<City> /etc/localtime`

`hwclock --systohc`

## Locales

`locale-gen`

edit /etc/locale.gen, uncomment en_US.UTF-8

<!-- and add LANG="C.UTF-8" even if the wiki says to do something different, idk  -->

## Set network hostname

`echo <hostname> > /etc/hostname`

## Root password

`passwd`

## Initcpio modules

I had to use a systemd-based initcpio otherwise decrypting disks required entering passwords 1 by 1

edit `/etc/mkinitcpio.conf`, change `HOOKS` to `HOOKS=(base systemd autodetect microcode modconf kms keyboard sd-vconsole block sd-encrypt lvm2 filesystems fsck)`

## Grub

### Install

Check that /boot and /boot/efi are properly mounted

`grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB`

### Config

Use `blkid` to get the UUID of the partitions your encrypted partitions are built upon (not the encrypted partitions themselves, but the physical device!!! I have no idea why it is like this)

Edit grub's config (`/etc/default/grub). For example, for the ids

```
crypt_0: e48a8a1d-6c93-4719-b140-4a5e59f931c5
crypt_1: 5a964a68-2b0f-4354-b649-7943ebc23668
```

You will add `([uuid of original partition, name of encrypted partition], root partition)`
```
GRUB_CMDLINE_LINUX="rd.luks.name=e48a8a1d-6c93-4719-b140-4a5e59f931c5=crypt_0 rd.luks.name=5a964a68-2b0f-4354-b649-7943ebc23668=crypt_1 root=/dev/lvm_group/root"
```

Also change `GRUB_DISABLE_OS_PROBER` to `false`

## Crypttab

Add into /etc/crypttab similar to how you added to grub. example:

```
crypt_0 UUID=e48a8a1d-6c93-4719-b140-4a5e59f931c5 none luks,discard
crypt_1 UUID=5a964a68-2b0f-4354-b649-7943ebc23668 none luks,discard
```

Also, add two \n at the bottom (don't ask) just in case

## Final setup

Needed for some initcpio module, don't ask: `touch /etc/vconsole.conf`

`mkinitcpio -P`

`grub-mkconfig -o /boot/grub/grub.cfg`

`systemctl enable NetworkManager`

**Warning**: if you have windows, you will need to mount its partition so that os-prober can detect it. For example:
```
lsblk # see where windows partition is (the basic data partition, not some weird efi partition or anything)
mount /dev/.... windows --mkdir
grub-mkconfig -o /boot/grub/grub.cfg

# if successful, it will say windows has been added
umount windows
rm -r windows
```

Verify that grub created an entry for arch linux before rebooting!!!!!

## Reboot, and use `setup.sh` when you come back in

# After first reboot

## Login as root

Enter `root` and then the password when prompted

## Setup secure boot

Using sbctl: `pacman -S sbctl`

Might as well do it now since you might break something. See [https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Assisted_process_with_sbctl](https://wiki.archlinux.org/title/Unified_Extensible_Firmware_Interface/Secure_Boot#Assisted_process_with_sbctl)

Basic steps are:

- reboot in setup mode
- create keys
- enroll keys
- sign files
- setup a hook for auto signing


## Edit sudoers file

Add this to sudoers with `visudo`. I left if the surrounding text. It is at the bottom of the file. Use `visudo`

```
##
## Runas alias specification
##

##
## User privilege specification
##
root ALL=(ALL:ALL) ALL

## Uncomment to allow members of group wheel to execute any command
# %wheel ALL=(ALL:ALL) ALL

## Same thing without a password
# %wheel ALL=(ALL:ALL) NOPASSWD: ALL

## Uncomment to allow members of group sudo to execute any command
# %sudo    ALL=(ALL:ALL) ALL

## Uncomment to allow any user to run sudo if they know the password
## of the user they are running the command as (root by default).
# Defaults targetpw  # Ask for the password of the target user
# ALL ALL=(ALL:ALL) ALL  # WARNING: only use this together with 'Defaults targetpw'

Defaults insults

# make a defaults secure_path?????

# wheel group
%wheel ALL=(ALL:ALL) ALL

## Read drop-in files from /etc/sudoers.d
@includedir /etc/sudoers.d
```

## Run the setup script

Install dependencies to run the script: `pacman -S git gum base-devel`

```
git clone https://github.com/IVSOP/linux-setup
cd linux-setup
./setup.sh
```
